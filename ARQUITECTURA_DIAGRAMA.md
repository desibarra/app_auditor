# ğŸ—ï¸ ARQUITECTURA SAT-GRADE - DIAGRAMA DE FLUJO

## Sistema de ValidaciÃ³n RFC-First Zero-Trust

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (React + Vite)                         â”‚
â”‚                                                                         â”‚
â”‚  [Usuario selecciona archivo XML/PDF/Excel]                           â”‚
â”‚                     â†“                                                   â”‚
â”‚  [FormData con file + empresaId (opcional)]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
                              HTTP POST
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MIDDLEWARE LAYER (NestJS)                          â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ›¡ï¸ RFC-VALIDATOR MIDDLEWARE (Zero-Trust)                        â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  1. Extraer RFC del archivo:                                    â”‚  â”‚
â”‚  â”‚     â”œâ”€ XML â†’ buscar Receptor/Rfc                               â”‚  â”‚
â”‚  â”‚     â”œâ”€ PDF â†’ OCR + pattern matching                            â”‚  â”‚
â”‚  â”‚     â””â”€ Excel â†’ buscar en celdas                                â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  2. Buscar empresa por RFC:                                     â”‚  â”‚
â”‚  â”‚     SELECT * FROM empresas WHERE rfc = ?                        â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  3. Validar integridad:                                         â”‚  â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚  â”‚     â”‚ Â¿Empresa existe con ese RFC?               â”‚             â”‚  â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â”‚              â†“ NO                    â†“ SÃ                       â”‚  â”‚
â”‚  â”‚         [REJECT]              Â¿Coincide con                    â”‚  â”‚
â”‚  â”‚                               empresaId solicitada?            â”‚  â”‚
â”‚  â”‚                                      â†“ NO        â†“ SÃ          â”‚  â”‚
â”‚  â”‚                                [RELOCATE]    [ALLOW]           â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  4. Auditar evento (SIEMPRE):                                   â”‚  â”‚
â”‚  â”‚     INSERT INTO audit_logs (...)                                â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  5. Inyectar empresaId validado en request                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
                    Request con empresaId VALIDADO
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CONTROLLER LAYER                                 â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  @Post('importar-xml')                                           â”‚  â”‚
â”‚  â”‚  @UseInterceptors(FileInterceptor('file'))                       â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  async importarXml(file, empresaId) {                           â”‚  â”‚
â”‚  â”‚    // empresaId ya viene VALIDADO del middleware                â”‚  â”‚
â”‚  â”‚    return await cfdiService.importarXml(file, empresaId);       â”‚  â”‚
â”‚  â”‚  }                                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SERVICE LAYER                                   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CfdiService.importarXml(file, empresaId)                        â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  try {                                                           â”‚  â”‚
â”‚  â”‚    1. Parsear XML                                                â”‚  â”‚
â”‚  â”‚    2. Validar CFDI                                               â”‚  â”‚
â”‚  â”‚    3. Verificar duplicados (UUID)                               â”‚  â”‚
â”‚  â”‚    4. Insertar en DB con empresaId VALIDADO                     â”‚  â”‚
â”‚  â”‚    5. Auditar Ã©xito                                              â”‚  â”‚
â”‚  â”‚    return SUCCESS                                                â”‚  â”‚
â”‚  â”‚  } catch (error) {                                               â”‚  â”‚
â”‚  â”‚    auditoriaService.logError(error)                              â”‚  â”‚
â”‚  â”‚    throw UserFriendlyError                                       â”‚  â”‚
â”‚  â”‚  }                                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATABASE LAYER (SQLite)                         â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  cfdi_recibidos                                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ uuid (PK)                                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ empresaId (FK â†’ empresas.id CASCADE)  â† GARANTIZADO        â”‚  â”‚
â”‚  â”‚  â”œâ”€ periodo_fiscal                                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ receptor_rfc                                                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ emisor_rfc                                                   â”‚  â”‚
â”‚  â”‚  â””â”€ ...                                                          â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  ÃNDICES:                                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ idx_empresa_periodo (empresaId, periodoFiscal)              â”‚  â”‚
â”‚  â”‚  â”œâ”€ idx_receptor_rfc (receptorRfc)                              â”‚  â”‚
â”‚  â”‚  â””â”€ idx_fecha (fecha)                                            â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  CONSTRAINTS:                                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ empresaId DEBE existir en tabla empresas                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ ON DELETE CASCADE                                            â”‚  â”‚
â”‚  â”‚  â””â”€ uuid UNIQUE                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  audit_logs                                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ id (PK)                                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ timestamp                                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ usuario_id                                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ empresa_id_solicitada                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ empresa_id_detectada                                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ empresa_id_final                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ rfc_detectado                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ accion (ALLOW, REJECT, RELOCATE)                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ proceso                                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ resultado                                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ razon                                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ ip_address                                                   â”‚  â”‚
â”‚  â”‚  â””â”€ ...                                                          â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â†’ INMUTABLE, solo INSERT                                        â”‚  â”‚
â”‚  â”‚  â†’ RetenciÃ³n: 5 aÃ±os mÃ­nimo                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EXCEPTION FILTER LAYER                             â”‚
â”‚                                                                         â”‚
â”‚  Si ocurre error en cualquier capa:                                    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  GlobalExceptionFilter                                           â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  1. Capturar excepciÃ³n                                           â”‚  â”‚
â”‚  â”‚  2. Traducir a lenguaje humano:                                  â”‚  â”‚
â”‚  â”‚     {                                                            â”‚  â”‚
â”‚  â”‚       "whatFailed": "ImportaciÃ³n de CFDI",                      â”‚  â”‚
â”‚  â”‚       "why": "El RFC no estÃ¡ registrado",                       â”‚  â”‚
â”‚  â”‚       "whatToDo": "Registra la empresa primero"                 â”‚  â”‚
â”‚  â”‚     }                                                            â”‚  â”‚
â”‚  â”‚  3. Auditar error                                                â”‚  â”‚
â”‚  â”‚  4. Log tÃ©cnico (solo para developers)                          â”‚  â”‚
â”‚  â”‚  5. Retornar HTTP con mensaje claro                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
                        Respuesta al usuario
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FRONTEND                                   â”‚
â”‚                                                                         â”‚
â”‚  Si todo OK:                                                            â”‚
â”‚    âœ“ "XML importado exitosamente"                                      â”‚
â”‚    âœ“ Actualizar dashboard                                              â”‚
â”‚                                                                         â”‚
â”‚  Si error:                                                              â”‚
â”‚    âœ— Mostrar mensaje claro                                             â”‚
â”‚    âœ— "El RFC XAXX010101000 no estÃ¡ registrado.                         â”‚
â”‚       Por favor, registra la empresa primero en                         â”‚
â”‚       ConfiguraciÃ³n > Empresas."                                        â”‚
â”‚    âœ— BotÃ³n "Registrar Empresa"                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de DetecciÃ³n Bancaria Multi-PatrÃ³n

```
[Archivo PDF/Excel recibido]
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BankPatternDetector.detect()       â”‚
â”‚                                      â”‚
â”‚  1. Extraer texto del archivo        â”‚
â”‚  2. Buscar keywords:                 â”‚
â”‚     - "BAJÃO" â†’ BanBajÃ­o            â”‚
â”‚     - "BBVA" â†’ BBVA                 â”‚
â”‚     - "SANTANDER" â†’ Santander       â”‚
â”‚  3. Validar patrones de fecha        â”‚
â”‚  4. Detectar nÃºmero de cuenta        â”‚
â”‚  5. Calcular confidence score        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
   Banco detectado + confidence
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Seleccionar Parser apropiado:       â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ BanBajioParser.parse()      â”‚    â”‚
â”‚  â”‚  - Detectar columnas        â”‚    â”‚
â”‚  â”‚  - Parsear movimientos      â”‚    â”‚
â”‚  â”‚  - Normalizar formato       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           O                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ BBVAParser.parse()          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           O                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ GenericBankParser.parse()   â”‚    â”‚
â”‚  â”‚  (Fallback con heurÃ­sticas) â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
   Array de NormalizedMovimiento
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BankImportService.validateBalance() â”‚
â”‚                                      â”‚
â”‚  âœ“ Total cargos                      â”‚
â”‚  âœ“ Total abonos                      â”‚
â”‚  âœ“ Saldo inicial vs final            â”‚
â”‚  âœ“ Diferencia < 1 centavo            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
   ValidaciÃ³n OK â†’ Persistir
           â†“
      Base de Datos
```

---

## Relaciones de Base de Datos Blindadas

```sql
empresas (PK: id)
    â†“ CASCADE
    â”œâ”€â”€ cfdi_recibidos (FK: empresa_id)
    â”‚   â†“ CASCADE
    â”‚   â””â”€â”€ evidencias (FK: cfdi_uuid)
    â”‚
    â”œâ”€â”€ movimientos_bancarios (FK: empresa_id)
    â”‚
    â””â”€â”€ audit_logs (FK: empresa_id_final)

-- Si se elimina empresa:
--   â†’ Todos sus CFDIs se eliminan
--   â†’ Todos sus movimientos bancarios se eliminan
--   â†’ Todas sus evidencias se eliminan
--   â†’ Logs de auditorÃ­a SE MANTIENEN (inmutables)

-- Imposible tener datos huÃ©rfanos
-- Imposible tener datos sin empresa
```

---

**FIN DEL DIAGRAMA**
